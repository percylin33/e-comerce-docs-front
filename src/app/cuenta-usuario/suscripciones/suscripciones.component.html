<div class="suscripciones-container">
  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <p>ğŸ“š Cargando tus suscripciones...</p>
    </div>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-card">
      <h3>âš ï¸ Error</h3>
      <p>{{ error }}</p>
      <button (click)="loadUserSubscriptions()" class="btn-retry">
        ğŸ”„ Reintentar
      </button>
    </div>
  </div>

  <!-- Sin suscripciones -->
  <div *ngIf="!loading && !error && suscripcionesArray.length === 0" class="empty-container">
    <div class="empty-card">
      <h3>ğŸ“š No tienes suscripciones activas</h3>
      <p>Explora nuestras membresÃ­as y encuentra la perfecta para ti</p>
      <button (click)="router.navigate(['/site/membresia'])" class="btn-membresias">
        ğŸ“ Ver MembresÃ­as
      </button>
    </div>
  </div>

  <!-- Lista de suscripciones -->
  <div *ngIf="!loading && !error && suscripcionesArray.length > 0">
    <div class="suscripciones-header">
      <h1>ğŸ“š Mis Suscripciones</h1>
      <p>Administra tus membresÃ­as y accede a todo tu contenido</p>
    </div>

    <!-- Botones de filtro -->
    <div class="filtros-container">
      <button 
        (click)="cambiarFiltro('vigentes')" 
        class="btn-filtro"
        [ngClass]="{'active': filtroActual === 'vigentes'}">
        âœ… Vigentes ({{ getContadorVigentes() }})
      </button>
      <button 
        (click)="cambiarFiltro('vencidas')" 
        class="btn-filtro"
        [ngClass]="{'active': filtroActual === 'vencidas'}">
        â° Vencidas ({{ getContadorVencidas() }})
      </button>
    </div>

    <!-- Mensaje cuando no hay suscripciones del filtro seleccionado -->
    <div *ngIf="suscripcionesFiltradas.length === 0" class="no-results-container">
      <div class="no-results-card">
        <div class="no-results-icon">
          {{ filtroActual === 'vigentes' ? 'âœ…' : 'â°' }}
        </div>
        <h3>
          {{ filtroActual === 'vigentes' ? 'No tienes suscripciones vigentes' : 'No tienes suscripciones vencidas' }}
        </h3>
        <p>
          {{ filtroActual === 'vigentes' ? 
             'Explora nuestras membresÃ­as para encontrar la perfecta para ti.' : 
             'Todas tus suscripciones estÃ¡n al dÃ­a.' 
          }}
        </p>
        <button 
          *ngIf="filtroActual === 'vigentes'" 
          (click)="router.navigate(['/site/membresia'])" 
          class="btn-membresias">
          ğŸ“ Ver MembresÃ­as
        </button>
      </div>
    </div>

  <div *ngFor="let sus of suscripcionesFiltradas; let i = index" class="suscripcion-card shimmer-effect"
       [ngClass]="{'vigente-card': isSubscriptionVigente(sus), 'vencida-card': isSubscriptionVencida(sus)}">
    <div class="estado-badge" [ngClass]="sus.estado === 'ACTIVA' ? 'activa' : 'inactiva'">
      {{ sus.estado === 'ACTIVA' ? 'âœ… Activa' : 'âŒ Inactiva' }}
    </div>
    
    <!-- Alerta de cuotas vencidas o prÃ³ximas a vencer -->
    <div *ngIf="getAlertType(sus) !== 'none'" class="alerta-vencimiento" [ngClass]="getAlertMessage(sus).type">
      <div class="alerta-header">
        <span class="alerta-icon" [innerHTML]="
          getAlertMessage(sus).type === 'danger' ? 'âš ï¸' : 
          getAlertMessage(sus).type === 'warning-urgent' ? 'â°' :
          getAlertMessage(sus).type === 'warning' ? 'âš ï¸' : 'ğŸ“…'
        "></span>
        <h4>{{ getAlertMessage(sus).title }}</h4>
      </div>
      <div class="alerta-content">
        <p [innerHTML]="getAlertMessage(sus).content"></p>
        <p class="mensaje-accion" [innerHTML]="
          getAlertMessage(sus).type === 'danger' ? 'ğŸ’¡ Regulariza tus pagos para reactivar tu suscripciÃ³n y acceder a todo el contenido.' :
          getAlertMessage(sus).type === 'warning-urgent' ? 'ğŸš¨ Realiza el pago hoy mismo para evitar la suspensiÃ³n de tu suscripciÃ³n.' :
          getAlertMessage(sus).type === 'warning' ? 'ğŸ’³ Te sugerimos realizar el pago lo antes posible para evitar inconvenientes.' :
          'âœ… MantÃ©n tus pagos al dÃ­a para disfrutar sin interrupciones de todos los beneficios.'
        "></p>
      </div>
    </div>
    
    <h2>ğŸ“ {{ sus.membresiaNombre }}</h2>
    <p>
      <strong>ğŸ“… PerÃ­odo:</strong> {{ sus.fechaInicio }} - {{ sus.fechaFin }}
    </p>

    <div class="botones-accion">
      <button (click)="togglePagos(i)" class="btn-pagos">
        {{ pagosVisibles[i] ? 'ğŸ’³ Ocultar pagos' : 'ğŸ’³ Ver pagos' }}
      </button>
      
      <button (click)="toggleDetalles(i)" class="btn-detalles">
        {{ detallesVisibles[i] ? 'ğŸ“‹ Ocultar detalles' : 'ğŸ“‹ Ver detalles' }}
      </button>
    </div>

    <!-- SecciÃ³n de pagos -->
    <div *ngIf="pagosVisibles[i]" class="pagos-container">
      <h4>ï¿½ Historial de Pagos</h4>
      <div *ngFor="let pago of sus.pagos" class="pago-card"
           [ngClass]="pago.paymentStatus === 'PENDIENTE' ? 'inactivo' : 'activo'">
        <div class="pago-header">
          <div class="pago-info">
            <span class="pago-monto">ğŸ’¸ S/ {{ pago.amount }}</span>
            <span *ngIf="pago.paymentStatus === 'PENDIENTE'" 
                  class="pago-orden"
                  [ngClass]="canPayment(pago, sus) ? 'proximo' : 'en-cola'">
              {{ canPayment(pago, sus) ? 'ğŸ‘‘ PrÃ³ximo pago' : 'ğŸ”’ Pago #' + getPaymentPosition(pago, sus) + ' en cola' }}
            </span>
          </div>
          <span class="pago-status" [ngClass]="pago.paymentStatus === 'PENDIENTE' ? 'inactivo' : 'activo'">
            {{ pago.paymentStatus === 'PENDIENTE' ? 'Pendiente' : 'Pagado' }}
          </span>
        </div>
        <div class="pago-detalle">
          <span>ğŸ“… {{ formatDate(pago.paymentDate) }}</span>
          <button *ngIf="pago.paymentStatus === 'PENDIENTE'" 
                  (click)="pagar(pago, sus)" 
                  class="btn-pagar"
                  [disabled]="!canPayment(pago, sus)"
                  [ngClass]="{'disabled': !canPayment(pago, sus)}"
                  [attr.title]="canPayment(pago, sus) ? 'Proceder con el pago' : 'Debe completar el pago anterior primero'">
            <span class="btn-icon">{{ canPayment(pago, sus) ? 'ğŸ’³' : 'â³' }}</span>
            <span class="btn-text">{{ canPayment(pago, sus) ? 'Pagar Ahora' : 'Pago Bloqueado' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n de detalles de materias -->
    <div *ngIf="detallesVisibles[i]" class="detalles-container">
      <h4>ğŸ“š Materias y Grados Disponibles</h4>
      <div class="materias-opciones">
        <div *ngFor="let materia of getKeys(parseMateriasOpciones(sus.materiasOpcionesJson))" class="materia-opcion">
          <div class="materia-nombre">
            <strong>{{ materia }}</strong>
          </div>
          <div class="grados-lista">
            <span *ngFor="let grado of parseMateriasOpciones(sus.materiasOpcionesJson)[materia]" 
                  class="grado-tag">
              {{ grado }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n de documentos -->
    <div class="documentos-section">
      <h3>ğŸ“š Documentos Disponibles</h3>
      <div class="materias-container">
        <div *ngFor="let nivel of getKeys(sus.documents)" class="materia-item">
          <div *ngFor="let materia of getKeys(sus.documents[nivel])">
            <button (click)="toggleMateria(i, nivel, materia)" class="materia-button">
              <span>ğŸ“– {{ materia }}</span>
              <span>{{ materiasVisibles[i + '-' + nivel + '-' + materia] ? 'â¯†' : 'â¯ˆ' }}</span>
            </button>
            
            <div *ngIf="materiasVisibles[i + '-' + nivel + '-' + materia]" class="grados-container">
              <div *ngFor="let grado of getKeys(sus.documents[nivel][materia])" class="grado-item">
                <button (click)="toggleGrado(nivel, materia, grado)" class="grado-button">
                  <span>ğŸ¯ {{ grado }}</span>
                  <span>{{ gradosVisibles[nivel + '-' + materia + '-' + grado] ? 'â¯†' : 'â¯ˆ' }}</span>
                </button>
                
                <div *ngIf="gradosVisibles[nivel + '-' + materia + '-' + grado]" class="documentos-grid">
                  <div *ngFor="let doc of sus.documents[nivel][materia][grado]" class="doc-card">
                    <h4>ğŸ“„ {{ doc.title }}</h4>
                    <p class="doc-description" [attr.title]="doc.description">{{ doc.description }}</p>
                    <div class="doc-footer">
                      
                      <button (click)="verDocumento(doc.fileUrlPublic)" class="btn-ver-doc">
                        ğŸ‘ï¸ Descargar Documentos
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>